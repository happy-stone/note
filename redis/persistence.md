<h1 id="rdb"><a href="#rdb">RDB 持久化</a></h1>


​    Redis 默认使用 RDB 持久化。创建一个包含数据库中存储的键值对信息的二进制文件，该文件可以被压缩。除了使用配置文件自动持久化之外，也可以通过执行 命令 吃出发持久化。`save` （阻塞服务器）和 `BFGSAVE` （非阻塞方式，使用子进程创建文件。）

​    当服务器启动时，会在工作目录查找是否有 RDB 文件，如果有就打开它，并且判断内容是否为空，如果不为空就读取文件数据库编号，切换到对应的数据库，加载数据，直到遇到 EOF，停止加载。

可以通过 设置 ` save = "" ` 来关闭持久化功能。


<h1 id="aof"><a href="#aof">AOF 持久化</a></h1>

​    AOF 是增量式持久化方法，通过配置 appendonly 启用。每次服务器执行完命令之后，都会以协议化文本的方式把执行的命令追加到 AOF 文件的尾部。服务器在重启时，只要重新执行保存的文件就能恢复数据。随着服务器运行，日志文件越来越大，许多操作冗余，不需要持续保存，可以执行 `BGREWRITEAOF` 生成新的文件，减小文件体积。

​    AOF 持久化安全性较高，但是体积较大，恢复速度慢，AOF 重写占用资源比较大。


<h1 id="rdb-aof"><a href="#rdb-aof">RDB-AOF 混合持久化</a></h1>

​    在执行 AOF 重写时，会把当前数据库数据生成 RDB 格式数据，并写入 AOF 文件开头，AOF 重写之后执行的命令以协议文本的方式保存在新的 AOF 文件中。


| 配置项                        | 默认值                                         | 说明                                                         |
| ----------------------------- | ---------------------------------------------- | ------------------------------------------------------------ |
| rdbcompression                | yes                                            | 数据保存到本地数据库时，是否压缩数据，采用 LZF 压缩。        |
| dbfilename                    | dump.rdb                                       | 本地数据库文件名                                             |
| dir                           | ./                                             | 本地数据库存放目录                                           |
| save                          | save 900 1<br />save 300 10<br />save 60 10000 | 在多长时间内，有多少次更新操作，<br />就将数据同步到数据文件，可以多个条件配合 |
| appendonly                    |                                                | 使用 AOF 方式持久化。                                        |
| appendfilename                |                                                | 保存的文件名称                                               |
| appendfsync                   |                                                | always：每次执行命令都直接保存到文件<br />everysec：每秒执行一次<br />no：不主动执行，由操作系统决定 |
| auto-aof-rewrite-min-size     |                                                | 出发 AOF 重新的最小体积                                      |
| auto-aof-rewrite-percentage   |                                                | 触发 AOF 重写的体积增大的比例<br />比如原来 10MB ，重写比例时 100%，<br />现在 到了 20MB 就需要重写。 |
| aof-rewrite-incremental-fsync |                                                |                                                              |
| aof-use-rdb-preamble          | no                                             | 混合持久化                                                   |
